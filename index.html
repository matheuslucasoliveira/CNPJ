<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta CNPJ</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/styles.css" rel="stylesheet">
</head>
<body>
    <div class="header">
        <div class="container">
            <h1 class="text-center mb-4">
                <i class="fas fa-building me-2"></i>Consulta CNPJ
            </h1>
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <form id="consultaForm" class="d-flex gap-2">
                        <input type="text" id="cnpj" name="cnpj" class="form-control" placeholder="Digite o CNPJ" required>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-2"></i>Consultar
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="loading" class="loading hidden"></div>
        <div id="error" class="alert alert-danger hidden" role="alert"></div>
        
        <div id="resultado" class="hidden">
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">
                        <i class="fas fa-info-circle me-2"></i>Informações Básicas
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="atividades-tab" data-bs-toggle="tab" data-bs-target="#atividades" type="button" role="tab">
                        <i class="fas fa-briefcase me-2"></i>Atividades
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="socios-tab" data-bs-toggle="tab" data-bs-target="#socios" type="button" role="tab">
                        <i class="fas fa-users me-2"></i>Quadro Societário
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="regimes-tab" data-bs-toggle="tab" data-bs-target="#regimes" type="button" role="tab">
                        <i class="fas fa-file-invoice-dollar me-2"></i>Regimes Especiais
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="myTabContent">
                <!-- Informações Básicas -->
                <div class="tab-pane fade show active" id="info" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="section-title">
                                        <i class="fas fa-building me-2"></i>Dados da Empresa
                                    </h5>
                                    <div class="mb-3">
                                        <span class="info-label">CNPJ:</span>
                                        <span class="info-value" id="info-cnpj"></span>
                                    </div>
                                    <div class="mb-3">
                                        <span class="info-label">Razão Social:</span>
                                        <span class="info-value" id="info-razao-social"></span>
                                    </div>
                                    <div class="mb-3">
                                        <span class="info-label">Nome Fantasia:</span>
                                        <span class="info-value" id="info-nome-fantasia"></span>
                                    </div>
                                    <div class="mb-3">
                                        <span class="info-label">Tipo:</span>
                                        <span class="info-value" id="info-tipo"></span>
                                    </div>
                                    <div class="mb-3">
                                        <span class="info-label">Porte:</span>
                                        <span class="info-value" id="info-porte"></span>
                                    </div>
                                    <div class="mb-3">
                                        <span class="info-label">Natureza Jurídica:</span>
                                        <span class="info-value" id="info-natureza"></span>
                                    </div>
                                    <div class="mb-3">
                                        <span class="info-label">Data de Abertura:</span>
                                        <span class="info-value" id="info-abertura"></span>
                                    </div>
                                    <div class="mb-3">
                                        <span class="info-label">Capital Social:</span>
                                        <span class="info-value" id="info-capital"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="section-title">
                                        <i class="fas fa-map-marker-alt me-2"></i>Endereço
                                    </h5>
                                    <div class="mb-3">
                                        <span class="info-label">Logradouro:</span>
                                        <span class="info-value" id="info-logradouro"></span>
                                    </div>
                                    <div class="mb-3">
                                        <span class="info-label">Número:</span>
                                        <span class="info-value" id="info-numero"></span>
                                    </div>
                                    <div class="mb-3">
                                        <span class="info-label">Complemento:</span>
                                        <span class="info-value" id="info-complemento"></span>
                                    </div>
                                    <div class="mb-3">
                                        <span class="info-label">Bairro:</span>
                                        <span class="info-value" id="info-bairro"></span>
                                    </div>
                                    <div class="mb-3">
                                        <span class="info-label">Município:</span>
                                        <span class="info-value" id="info-municipio"></span>
                                    </div>
                                    <div class="mb-3">
                                        <span class="info-label">UF:</span>
                                        <span class="info-value" id="info-uf"></span>
                                    </div>
                                    <div class="mb-3">
                                        <span class="info-label">CEP:</span>
                                        <span class="info-value" id="info-cep"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="card mt-3">
                                <div class="card-body">
                                    <h5 class="section-title">
                                        <i class="fas fa-phone me-2"></i>Contato
                                    </h5>
                                    <div class="mb-3">
                                        <span class="info-label">Telefone:</span>
                                        <span class="info-value" id="info-telefone"></span>
                                    </div>
                                    <div class="mb-3">
                                        <span class="info-label">Email:</span>
                                        <span class="info-value" id="info-email"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Atividades -->
                <div class="tab-pane fade" id="atividades" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="section-title">
                                <i class="fas fa-star me-2"></i>Atividade Principal
                            </h5>
                            <div id="atividade-principal"></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <h5 class="section-title">
                                <i class="fas fa-list me-2"></i>Atividades Secundárias
                            </h5>
                            <div id="atividades-secundarias"></div>
                        </div>
                    </div>
                </div>

                <!-- Quadro Societário -->
                <div class="tab-pane fade" id="socios" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="section-title">
                                <i class="fas fa-users me-2"></i>Sócios
                            </h5>
                            <div id="lista-socios"></div>
                        </div>
                    </div>
                </div>

                <!-- Regimes Especiais -->
                <div class="tab-pane fade" id="regimes" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="section-title">
                                <i class="fas fa-file-invoice-dollar me-2"></i>Simples Nacional
                            </h5>
                            <div class="mb-3">
                                <span class="info-label">Optante pelo Simples:</span>
                                <span class="info-value" id="info-simples"></span>
                            </div>
                            <div class="mb-3">
                                <span class="info-label">Data de Opção:</span>
                                <span class="info-value" id="info-data-simples"></span>
                            </div>
                            <div class="mb-3">
                                <span class="info-label">Data de Exclusão:</span>
                                <span class="info-value" id="info-exclusao-simples"></span>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <h5 class="section-title">
                                <i class="fas fa-user-tie me-2"></i>MEI
                            </h5>
                            <div class="mb-3">
                                <span class="info-label">Optante pelo MEI:</span>
                                <span class="info-value" id="info-mei"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Metadados -->
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="section-title">
                        <i class="fas fa-info-circle me-2"></i>Metadados da Consulta
                    </h5>
                    <div class="metadata">
                        <div class="mb-2">
                            <span class="info-label">Início da Consulta:</span>
                            <span class="info-value" id="meta-inicio"></span>
                        </div>
                        <div class="mb-2">
                            <span class="info-label">Fim da Consulta:</span>
                            <span class="info-value" id="meta-fim"></span>
                        </div>
                        <div class="mb-2">
                            <span class="info-label">Duração:</span>
                            <span class="info-value" id="meta-duracao"></span>
                        </div>
                        <div class="mb-2">
                            <span class="info-label">Status:</span>
                            <span class="info-value" id="meta-status"></span>
                        </div>
                        <div class="mb-2">
                            <span class="info-label">Mensagem:</span>
                            <span class="info-value" id="meta-mensagem"></span>
                        </div>
                        <div>
                            <span class="info-label">Billing:</span>
                            <span class="info-value" id="meta-billing"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#cnpj').mask('00.000.000/0000-00');

            function validarCNPJ(cnpj) {
                cnpj = cnpj.replace(/[^\d]/g, '');
                
                if (cnpj.length !== 14) return false;
                if (/^(\d)\1+$/.test(cnpj)) return false;

                let soma = 0;
                let peso = 5;
                for (let i = 0; i < 12; i++) {
                    soma += parseInt(cnpj.charAt(i)) * peso;
                    peso = peso === 2 ? 9 : peso - 1;
                }
                let digito = 11 - (soma % 11);
                if (digito > 9) digito = 0;
                if (parseInt(cnpj.charAt(12)) !== digito) return false;

                soma = 0;
                peso = 6;
                for (let i = 0; i < 13; i++) {
                    soma += parseInt(cnpj.charAt(i)) * peso;
                    peso = peso === 2 ? 9 : peso - 1;
                }
                digito = 11 - (soma % 11);
                if (digito > 9) digito = 0;
                if (parseInt(cnpj.charAt(13)) !== digito) return false;

                return true;
            }

            function formatMoney(value) {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value);
            }

            function formatDate(dateStr) {
                if (!dateStr) return 'Não informado';
                const date = new Date(dateStr);
                return date.toLocaleDateString('pt-BR');
            }

            function toggleElements(loading = false, error = false, result = false) {
                $('#loading').toggleClass('hidden', !loading);
                $('#error').toggleClass('hidden', !error);
                $('#resultado').toggleClass('hidden', !result);
            }

            $('#consultaForm').on('submit', function(e) {
                e.preventDefault();
                
                const cnpjFormatado = $('#cnpj').val();
                const cnpj = cnpjFormatado.replace(/[^\d]/g, '');
                
                if (!cnpj) {
                    $('#error').html(`
                        <div class="alert alert-danger" role="alert">
                            <h5 class="alert-heading">CNPJ não fornecido</h5>
                            <p class="mb-0">Por favor, digite um CNPJ válido.</p>
                        </div>
                    `).removeClass('hidden');
                    return;
                }

                if (!validarCNPJ(cnpj)) {
                    $('#error').html(`
                        <div class="alert alert-danger" role="alert">
                            <h5 class="alert-heading">CNPJ inválido</h5>
                            <p class="mb-0">O CNPJ informado não é válido. Verifique se foi digitado corretamente.</p>
                        </div>
                    `).removeClass('hidden');
                    return;
                }

                toggleElements(true, false, false);

                $.ajax({
                    url: '/consultar',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ cnpj: cnpj }),
                    success: function(response) {
                        $('#info-cnpj').text(response.cnpj);
                        $('#info-razao-social').text(response.nome);
                        $('#info-nome-fantasia').text(response.fantasia || 'Não informado');
                        $('#info-tipo').text(response.tipo);
                        $('#info-porte').text(response.porte);
                        $('#info-natureza').text(response.natureza_juridica);
                        $('#info-abertura').text(formatDate(response.abertura));
                        $('#info-capital').text(formatMoney(response.capital_social));

                        $('#info-logradouro').text(response.logradouro);
                        $('#info-numero').text(response.numero);
                        $('#info-complemento').text(response.complemento || 'Não informado');
                        $('#info-bairro').text(response.bairro);
                        $('#info-municipio').text(response.municipio);
                        $('#info-uf').text(response.uf);
                        $('#info-cep').text(response.cep);

                        $('#info-telefone').text(response.telefone || 'Não informado');
                        $('#info-email').text(response.email || 'Não informado');

                        $('#atividade-principal').html(`
                            <div class="mb-3">
                                <span class="badge badge-primary">${response.atividade_principal[0].code}</span>
                                <span class="ms-2">${response.atividade_principal[0].text}</span>
                            </div>
                        `);

                        const atividadesHtml = response.atividades_secundarias.map(ativ => `
                            <div class="mb-3">
                                <span class="badge badge-primary">${ativ.code}</span>
                                <span class="ms-2">${ativ.text}</span>
                            </div>
                        `).join('');
                        $('#atividades-secundarias').html(atividadesHtml);

                        const sociosHtml = response.quadro_socios.map(socio => `
                            <div class="socio-card">
                                <div class="mb-2">
                                    <span class="info-label">Nome:</span>
                                    <span class="info-value">${socio.nome}</span>
                                </div>
                                <div class="mb-2">
                                    <span class="info-label">Qualificação:</span>
                                    <span class="info-value">${socio.qual}</span>
                                </div>
                                <div>
                                    <span class="info-label">País de Origem:</span>
                                    <span class="info-value">${socio.pais_origem || 'Brasil'}</span>
                                </div>
                            </div>
                        `).join('');
                        $('#lista-socios').html(sociosHtml || '<p>Nenhum sócio encontrado</p>');

                        $('#info-simples').text('Não informado');
                        $('#info-data-simples').text('Não informado');
                        $('#info-exclusao-simples').text('Não informado');
                        $('#info-mei').text('Não informado');

                        $('#meta-inicio').text(response.metadata.start_time);
                        $('#meta-fim').text(response.metadata.end_time);
                        $('#meta-duracao').text(response.metadata.duration);
                        $('#meta-status').text(response.status);
                        $('#meta-mensagem').text('Consulta realizada com sucesso');
                        $('#meta-billing').text(`Créditos: ${response.metadata.billing.credits}, Custo: ${formatMoney(response.metadata.billing.cost)}`);

                        toggleElements(false, false, true);
                    },
                    error: function(xhr) {
                        let errorMessage = 'Erro ao consultar CNPJ';
                        let errorDetails = '';

                        switch (xhr.status) {
                            case 400:
                                errorMessage = 'CNPJ inválido ou não fornecido';
                                errorDetails = xhr.responseJSON?.error || 'Verifique o CNPJ informado';
                                break;
                            case 404:
                                errorMessage = 'CNPJ não encontrado';
                                errorDetails = 'O CNPJ informado não foi encontrado na base de dados';
                                break;
                            case 429:
                                errorMessage = 'Limite de requisições excedido';
                                errorDetails = 'Por favor, aguarde alguns segundos antes de tentar novamente';
                                break;
                            case 503:
                                errorMessage = 'Serviço temporariamente indisponível';
                                errorDetails = 'O serviço está passando por manutenção. Tente novamente em alguns minutos';
                                break;
                            case 500:
                                errorMessage = 'Erro interno do servidor';
                                errorDetails = 'Ocorreu um erro inesperado. Tente novamente mais tarde';
                                break;
                            default:
                                errorMessage = xhr.responseJSON?.error || errorMessage;
                                errorDetails = xhr.responseJSON?.details || '';
                        }

                        $('#error').html(`
                            <div class="alert alert-danger" role="alert">
                                <h5 class="alert-heading">${errorMessage}</h5>
                                ${errorDetails ? `<p class="mb-0">${errorDetails}</p>` : ''}
                            </div>
                        `).removeClass('hidden');

                        toggleElements(false, true, false);
                    }
                });
            });
        });
    </script>
</body>
</html> 